# Документация Investment Data Stream Service

## Обзор

`InvestmentDataStreamService` - это высокопроизводительный сервис для потоковой обработки финансовых данных от Tinkoff Invest API. Сервис получает данные о сделках и свечах в реальном времени, сохраняет их в PostgreSQL и предоставляет Telegram бота для мониторинга и управления.

## Структура документации

### 📊 [Статистика сервиса](SERVICE_STATISTICS.md)

Подробное описание всех метрик и показателей производительности:

- Основные счетчики (сделки, свечи, ошибки)
- Статистика по типам инструментов (акции, фьючерсы, индикативы)
- Метрики производительности и утилизации ресурсов
- Интерпретация данных и диагностика проблем

### 🔌 [API Reference](API_REFERENCE.md)

Полное описание REST API сервиса:

- Endpoints для управления и мониторинга
- Форматы запросов и ответов
- Примеры использования с различными языками
- Обработка ошибок и коды ответов

### 📈 [Руководство по мониторингу](MONITORING_GUIDE.md)

Практическое руководство по настройке мониторинга:

- Ключевые метрики для отслеживания
- Настройка Prometheus, Grafana, Zabbix
- Диагностика проблем и автоматизация
- Скрипты мониторинга и уведомления

### 💾 [Кэширование инструментов](CACHE_API.md)

Полное руководство по системе кэширования:

- Автоматический прогрев кэша при старте
- REST API для управления кэшем
- Мониторинг производительности кэша
- Настройка и оптимизация

**Быстрый старт**: [CACHE_QUICK_START.md](CACHE_QUICK_START.md)

### 🤖 [Telegram Bot](TELEGRAM_BOT.md)

Руководство по настройке и использованию Telegram бота:

- Настройка бота и получение токена
- Доступные команды и функции
- Мониторинг через Telegram
- Уведомления и алерты

### ⚡ [Многопоточность и асинхронность](CONCURRENCY_AND_ASYNC.md)

Подробное описание реализации многопоточности и асинхронности:

- ExecutorService и пулы потоков
- CompletableFuture для асинхронных операций
- Semaphore для контроля конкурентности
- Atomic типы для thread-safety
- Volatile переменные
- Потоковая обработка данных
- Координация сервисов
- Оптимизация производительности

## Быстрый старт

### Запуск сервиса

```bash
# Сборка проекта
mvn clean package -DskipTests

# Запуск
java -jar target/investment-data-stream-service-1.0.0.jar
```

### Проверка работы

```bash
# Запуск стрима trades
curl -X POST http://localhost:8084/api/stream/trades/start

# Запуск стрима минутных свечей
curl -X POST http://localhost:8084/api/stream/minute-candles/start

# Запуск стрима цен последних сделок
curl -X POST http://localhost:8084/api/stream/last-price/start

# Получение метрик стрима trades
curl http://localhost:8084/api/stream/trades/metrics

# Получение всех акций
curl http://localhost:8084/api/instruments/shares
```

## Основные возможности

### 📡 Потоковые данные

- **Trade Stream**: Обезличенные сделки в реальном времени (`/api/stream/trades`)
- **MinuteCandle Stream**: Минутные свечи для всех инструментов (`/api/stream/minute-candles`)
- **LastPrice Stream**: Цены последних сделок (`/api/stream/last-price`)
- **Limit Monitoring Stream**: Мониторинг лимитов с уведомлениями в Telegram (`/api/stream/limits`)
- **Инструменты**: Акции, фьючерсы, индикативные инструменты (`/api/instruments`)

### 🤖 Telegram Bot

- **Мониторинг**: Проверка статуса сервиса через Telegram
- **Управление**: Запуск и остановка потоков данных
- **Уведомления**: Получение алертов о состоянии системы
- **Интерактивность**: Простые команды для управления

### 💾 Кэширование инструментов

- **Автоматический прогрев**: Загрузка всех инструментов при старте
- **Высокая скорость**: Доступ к данным в 100-1000 раз быстрее
- **REST API**: Управление и мониторинг кэша
- **Статистика производительности**: hitRate, missRate, evictions
- **Кэш лимитов**: Автоматическое обновление в 14:00 и 19:00 по рабочим дням
- **Кэш уведомлений**: Использование Caffeine Cache для предотвращения дубликатов

### 🚀 Высокая производительность

- Асинхронная обработка данных
- Батчевые операции с БД
- Оптимизированные пулы соединений
- Контроль конкурентности
- In-memory кэширование инструментов

### 📊 Мониторинг

- Детальная статистика в реальном времени
- Метрики по типам инструментов
- Отслеживание производительности
- REST API для интеграции

### 🔧 Надежность

- Обработка ошибок и восстановление
- Управление ресурсами
- Логирование и диагностика
- Graceful shutdown

## Архитектура

Сервис использует модульную архитектуру с независимыми стримами:

```
┌─────────────────────────────────────────────────────────────┐
│                    Tinkoff Invest API                        │
│                    (gRPC Streams)                            │
└──────────────┬───────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────┐
│              Investment Data Stream Service                   │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Trade Stream  │  │ Candle Stream│  │ LastPrice     │      │
│  │              │  │              │  │ Stream        │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                  │               │
│         ▼                 ▼                  ▼               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              PostgreSQL Database                      │   │
│  │  invest.trades | invest.minute_candles |              │   │
│  │  invest.last_prices                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Limit Monitor│  │ Cache Service│  │ Instrument   │      │
│  │              │  │              │  │ Service      │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼──────────────────┼──────────────────┼──────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│              REST API + Telegram Bot                           │
│  /api/stream/* | /api/cache/* | /api/instruments/*           │
└─────────────────────────────────────────────────────────────┘
```

Каждый стрим работает независимо и имеет свой контроллер, процессор и таблицу в БД.

Подробнее о новой архитектуре: [NEW_STREAMING_ARCHITECTURE.md](NEW_STREAMING_ARCHITECTURE.md)

## Конфигурация

### Переменные окружения

```bash
# .env файл
TINKOFF_API_TOKEN=your_token_here
DB_PASSWORD=your_db_password
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_BOT_USERNAME=your_bot_username
```

### Основные настройки

```properties
# application.properties
server.port=8084
spring.datasource.url=jdbc:postgresql://localhost:5434/postgres
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.stream.hikari.maximum-pool-size=50
```

## Мониторинг в реальном времени

### Ключевые метрики

| Метрика                  | Описание           | Критичность |
| ------------------------ | ------------------ | ----------- |
| `running`                | Статус сервиса     | Критическая |
| `connected`              | Подключение к API  | Высокая     |
| `overallErrorRate`       | Процент ошибок     | Высокая     |
| `overallProcessingRate`  | Скорость обработки | Средняя     |
| `tradeInsertUtilization` | Утилизация буфера  | Средняя     |

### Алерты

- **Критические**: Сервис остановлен, потеря данных
- **Предупреждения**: Высокий уровень ошибок, низкая производительность
- **Информационные**: Статистика работы, изменения конфигурации

## Поддержка

### Логирование

- Все операции логируются в `logs/application.log`
- Агрегированная статистика каждые 1000 событий
- Детальные логи ошибок для диагностики

### Диагностика

- REST API для проверки состояния
- Метрики производительности в реальном времени
- Автоматическое восстановление при сбоях

### Масштабирование

- Горизонтальное масштабирование через load balancer
- Настройка пулов соединений БД
- Оптимизация конфигурации под нагрузку

## Лицензия

Проект разработан для внутреннего использования.

---

**Версия документации**: 2.0  
**Последнее обновление**: 2025-11-03  
**Автор**: Investment Data Stream Service Team

### 🔄 Последние обновления

- ✅ Новая модульная архитектура с независимыми стримами
- ✅ Отдельные контроллеры для каждого типа стрима (Trade, MinuteCandle, LastPrice, Limits)
- ✅ Каждый стрим имеет свой процессор и таблицу в БД
- ✅ Добавлен автоматический cron scheduler для обновления кэша лимитов в 14:00 и 19:00 по рабочим дням
- ✅ Кэш уведомлений переведен с ConcurrentHashMap на Caffeine Cache
- ✅ Добавлен кэш `limitsCache` и `notificationsCache` в систему кэширования
- ✅ Обновлена документация по новой архитектуре и API

### 📚 Дополнительная документация

- **[Новая архитектура стриминга](NEW_STREAMING_ARCHITECTURE.md)** - Подробное описание новой архитектуры
- **[Архитектурные диаграммы](ARCHITECTURE_DIAGRAM.md)** - Визуализация системы
