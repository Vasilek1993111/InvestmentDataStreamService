package com.example.investmentdatastreamservice.service;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

/**
 * –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–∏–º–∏—Ç–æ–≤
 * 
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
 * –∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
 */
@Service
public class LimitMonitoringScheduler {
    
    private static final Logger logger = LoggerFactory.getLogger(LimitMonitoringScheduler.class);
    
    private final LimitMonitorService limitMonitorService;
    private final LimitsService limitsService;
    private final CacheWarmupService cacheWarmupService;
    
    public LimitMonitoringScheduler(LimitMonitorService limitMonitorService, LimitsService limitsService,
                                   CacheWarmupService cacheWarmupService) {
        this.limitMonitorService = limitMonitorService;
        this.limitsService = limitsService;
        this.cacheWarmupService = cacheWarmupService;
    }
    
    /**
     * –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
     * 
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:01 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
     * –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–Ω–∏.
     */
    @Scheduled(cron = "0 1 0 * * *", zone = "Europe/Moscow")
    public void clearDailyNotificationsCache() {
        try {
            logger.info("üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ª–∏–º–∏—Ç–∞—Ö");
            limitMonitorService.clearDailyNotifications();
            logger.info("‚úÖ –ö—ç—à —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ª–∏–º–∏—Ç–∞—Ö –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        } catch (Exception e) {
            logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {}", e.getMessage(), e);
        }
    }
    
    /**
     * –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–∏–º–∏—Ç–æ–≤
     * 
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 09:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
     * –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç—ã –∑–∞ –Ω–µ–¥–µ–ª—é.
     */
    @Scheduled(cron = "0 0 9 * * MON", zone = "Europe/Moscow")
    public void weeklyStatisticsReport() {
        try {
            logger.info("üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–∏–º–∏—Ç–æ–≤");
            
            var stats = limitMonitorService.getStatistics();
            
            logger.info("=== –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –õ–ò–ú–ò–¢–û–í ===");
            logger.info("üìà –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∞–ª–µ—Ä—Ç–æ–≤: {}", stats.get("totalAlertsProcessed"));
            logger.info("‚ö†Ô∏è –ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –ª–∏–º–∏—Ç—É: {}", stats.get("approachingLimitAlerts"));
            logger.info("üö® –õ–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç: {}", stats.get("limitReachedAlerts"));
            logger.info("üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {}", stats.get("notificationsSent"));
            logger.info("üìÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å: {}", stats.get("dailyNotificationsCount"));
            logger.info("ü§ñ Telegram –∫–∞–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω: {}", stats.get("telegramChannelConfigured"));
            logger.info("================================================");
            
        } catch (Exception e) {
            logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {}", e.getMessage(), e);
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ –≤ 14:00 –ø–æ —Ä–∞–±–æ—á–∏–º –¥–Ω—è–º
     * 
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞) –≤ 14:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
     * –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–∞–∫—Ü–∏–π –∏ —Ñ—å—é—á–µ—Ä—Å–æ–≤).
     * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–º–∏—Ç–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –¥–Ω—è.
     */
    @Scheduled(cron = "0 0 14 * * MON-FRI", zone = "Europe/Moscow")
    public void refreshLimitsCacheAt14() {
        try {
            logger.info("üîÑ [14:00] –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤");
            var stats = limitsService.refreshLimitsCache();
            
            logger.info("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–≠–®–ê –õ–ò–ú–ò–¢–û–í [14:00] ===");
            logger.info("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {}", stats.get("successCount"));
            logger.info("‚ùå –û—à–∏–±–æ–∫: {}", stats.get("errorCount"));
            logger.info("‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: {}", stats.get("skippedCount"));
            logger.info("‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {} –º—Å", stats.get("durationMs"));
            logger.info("================================================");
            
        } catch (Exception e) {
            logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ [14:00]: {}", e.getMessage(), e);
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ –≤ 19:00 –ø–æ —Ä–∞–±–æ—á–∏–º –¥–Ω—è–º
     * 
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞) –≤ 19:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
     * –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–∞–∫—Ü–∏–π –∏ —Ñ—å—é—á–µ—Ä—Å–æ–≤).
     * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –≤–µ—á–µ—Ä–Ω–µ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–µ–π.
     */
    @Scheduled(cron = "0 0 19 * * MON-FRI", zone = "Europe/Moscow")
    public void refreshLimitsCacheAt19() {
        try {
            logger.info("üîÑ [19:00] –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤");
            var stats = limitsService.refreshLimitsCache();
            
            logger.info("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–≠–®–ê –õ–ò–ú–ò–¢–û–í [19:00] ===");
            logger.info("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {}", stats.get("successCount"));
            logger.info("‚ùå –û—à–∏–±–æ–∫: {}", stats.get("errorCount"));
            logger.info("‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: {}", stats.get("skippedCount"));
            logger.info("‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {} –º—Å", stats.get("durationMs"));
            logger.info("================================================");
            
        } catch (Exception e) {
            logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞ –ª–∏–º–∏—Ç–æ–≤ [19:00]: {}", e.getMessage(), e);
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω –≤ 2:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
     * 
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
     * –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
     * 
     * –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ —Å—Ä–∞–∑—É –∏–∑ –ë–î –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ 2:00, –∫–∞–∫ –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫—ç—à–∏.
     * TTL –∫—ç—à–∞: 24 —á–∞—Å–∞, –ø–æ—ç—Ç–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ—á—å—é –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å.
     */
    @Scheduled(cron = "0 0 2 * * *", zone = "Europe/Moscow")
    public void refreshHistoricalPricesCacheAt2() {
        try {
            logger.info("üîÑ [02:00] –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω");
            var stats = cacheWarmupService.refreshHistoricalPricesCache();
            
            if ((Boolean) stats.get("success")) {
                logger.info("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–≠–®–ê –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–• –¶–ï–ù [02:00] ===");
                logger.info("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {}", stats.get("successCount"));
                logger.info("üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {}", stats.get("totalCount"));
                logger.info("‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {} –º—Å", stats.get("durationMs"));
                logger.info("================================================");
            } else {
                logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω [02:00]: {}", stats.get("error"));
            }
        } catch (Exception e) {
            logger.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω [02:00]: {}", e.getMessage(), e);
        }
    }
}
